# =============================================================================
# FULL PIPELINE - END-TO-END SERVERLESS ORCHESTRATION (SIMPLIFIED)
# =============================================================================
# 
# Purpose: Complete Medallion Architecture pipeline (Bronze → Silver → Gold)
# Author: Diego Mayorga
# Date: 2026-01-06
# Compute: Serverless (workspace requirement)
# 
# Design Decision: Use Gold Orchestrator instead of individual notebooks
# Rationale: 
#   - Orchestrator already validated for Serverless compatibility
#   - Reduces complexity from 12 tasks to 3 tasks
#   - Single point of failure for Gold layer (easier debugging)
#   - Orchestrator handles internal dependencies
#
# Trade-off: Sacrifices parallel dimension execution for simplicity/reliability
# 
# =============================================================================

resources:
  jobs:
    full_pipeline:
      name: "Full Pipeline - Bronze to Gold"
      description: |
        Complete end-to-end Medallion Architecture pipeline (Serverless)
        Simplified: Bronze → Silver → Gold Orchestrator (3 tasks)
      
      tags:
        project: "BI_Market_Visibility"
        layer: "orchestration"
        owner: "diego.mayorgacapera@gmail.com"
      
      # ─────────────────────────────────────────────────────────────────────
      # NOTIFICATIONS
      # ─────────────────────────────────────────────────────────────────────
      email_notifications:
        on_start:
          - "diego.mayorgacapera@gmail.com"
        on_failure:
          - "diego.mayorgacapera@gmail.com"
        on_success:
          - "diego.mayorgacapera@gmail.com"
        no_alert_for_skipped_runs: true
      
      # ─────────────────────────────────────────────────────────────────────
      # TIMEOUT POLICY
      # ─────────────────────────────────────────────────────────────────────
      timeout_seconds: 10800  # 3 hours max (reduced from 4h due to simpler flow)
      
      # ─────────────────────────────────────────────────────────────────────
      # SCHEDULE: Weekly on Sunday at 2 AM (full refresh)
      # ─────────────────────────────────────────────────────────────────────
      schedule:
        quartz_cron_expression: "0 0 2 ? * SUN"
        timezone_id: "America/Bogota"
        pause_status: "PAUSED"
      
      # ═══════════════════════════════════════════════════════════════════════
      # TASK DEFINITIONS - SIMPLIFIED DAG (Serverless Compute)
      # ═══════════════════════════════════════════════════════════════════════
      #
      # Simplified Execution Flow (3 tasks instead of 12):
      #
      #   ┌─────────────────────┐
      #   │  bronze_ingestion   │  ← PHASE 1: Raw data ingestion
      #   │  (~3-4 min)         │
      #   └──────────┬──────────┘
      #              │
      #   ┌──────────▼──────────┐
      #   │silver_standardization│  ← PHASE 2: Cleaning & validation
      #   │  (~3 min)           │
      #   └──────────┬──────────┘
      #              │
      #   ┌──────────▼──────────┐
      #   │  gold_orchestrator  │  ← PHASE 3: All Gold tables
      #   │  (~8-10 min)        │     - 3 Dimensions (date, product, pdv)
      #   │                     │     - 3 Facts (sell_in, price_audit, stock)
      #   │                     │     - 2 KPIs (visibility, market_share)
      #   │                     │     - Validation (read-only checks)
      #   └─────────────────────┘
      #
      # Total estimated runtime: ~15-20 minutes
      #
      # ═══════════════════════════════════════════════════════════════════════
      
      tasks:
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 1: BRONZE INGESTION
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "bronze_ingestion"
          description: |
            Ingest raw data from sources into Bronze Delta tables.
            Sources: CSV (semicolon/comma), Excel (.xlsx)
            Tables: bronze_master_pdv, bronze_master_products, 
                    bronze_price_audit, bronze_sell_in
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/.bundle/BI_Market_Visibility/dev/files/notebooks/bronze/01_bronze_ingestion"
            source: "WORKSPACE"
          timeout_seconds: 1800  # 30 min max
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 2: SILVER STANDARDIZATION
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "silver_standardization"
          description: |
            Transform Bronze to Silver with standardization.
            Operations: Deduplication, snake_case, quality flags
            Tables: silver_master_pdv, silver_master_products,
                    silver_price_audit, silver_sell_in
          depends_on:
            - task_key: "bronze_ingestion"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/.bundle/BI_Market_Visibility/dev/files/notebooks/silver/02_silver_standardization"
            source: "WORKSPACE"
          timeout_seconds: 2400  # 40 min max
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 3: GOLD ORCHESTRATOR (All Gold tables in one execution)
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_orchestrator"
          description: |
            Execute complete Gold layer via orchestrator.
            Handles internal dependencies and execution order.
            Tables created:
              - Dimensions: gold_dim_date, gold_dim_product, gold_dim_pdv
              - Facts: gold_fact_sell_in, gold_fact_price_audit, gold_fact_stock
              - KPIs: gold_kpi_market_visibility, gold_kpi_market_share
            Includes: Post-execution validation (referential integrity)
          depends_on:
            - task_key: "silver_standardization"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/.bundle/BI_Market_Visibility/dev/files/notebooks/gold/03_gold_orchestrator"
            source: "WORKSPACE"
            base_parameters:
              execute_pipeline: "yes"
          timeout_seconds: 3600  # 60 min max for all Gold operations
