# =============================================================================
# FULL PIPELINE - END-TO-END SERVERLESS ORCHESTRATION
# =============================================================================
# 
# Purpose: Complete Medallion Architecture pipeline (Bronze → Silver → Gold)
# Author: Diego Mayorga
# Date: 2026-01-06
# Compute: Serverless (workspace requirement)
# 
# =============================================================================

resources:
  jobs:
    full_pipeline:
      name: "Full Pipeline - Bronze to Gold"
      description: |
        Complete end-to-end Medallion Architecture pipeline (Serverless)
        Executes all layers in sequence with proper dependencies
      
      tags:
        project: "BI_Market_Visibility"
        layer: "orchestration"
        owner: "diego.mayorgacapera@gmail.com"
      
      # ─────────────────────────────────────────────────────────────────────
      # NOTIFICATIONS
      # ─────────────────────────────────────────────────────────────────────
      email_notifications:
        on_start:
          - "diego.mayorgacapera@gmail.com"
        on_failure:
          - "diego.mayorgacapera@gmail.com"
        on_success:
          - "diego.mayorgacapera@gmail.com"
        no_alert_for_skipped_runs: true
      
      # ─────────────────────────────────────────────────────────────────────
      # TIMEOUT POLICY
      # ─────────────────────────────────────────────────────────────────────
      timeout_seconds: 14400  # 4 hours max for full pipeline
      
      # ─────────────────────────────────────────────────────────────────────
      # SCHEDULE: Weekly on Sunday at 2 AM (full refresh)
      # ─────────────────────────────────────────────────────────────────────
      schedule:
        quartz_cron_expression: "0 0 2 ? * SUN"
        timezone_id: "America/Bogota"
        pause_status: "PAUSED"
      
      # ═══════════════════════════════════════════════════════════════════════
      # TASK DEFINITIONS - COMPLETE DAG (Serverless Compute)
      # ═══════════════════════════════════════════════════════════════════════
      #
      # Execution Flow:
      #
      #   ┌─────────────────┐
      #   │ bronze_ingestion│  ← PHASE 1
      #   └────────┬────────┘
      #            │
      #   ┌────────▼────────┐
      #   │silver_standard  │  ← PHASE 2
      #   └────────┬────────┘
      #            │
      #   ┌────────┼────────┬────────┐
      #   ▼        ▼        ▼        │
      # dim_date dim_prod dim_pdv   │  ← PHASE 3
      #   │        │        │        │
      #   └────────┼────────┘        │
      #            │                 │
      #   ┌────────┼────────┐        │
      #   ▼        ▼        ▼        │
      # fact_si  fact_pa  fact_st   │  ← PHASE 4
      #   │        │        │        │
      #   └────────┼────────┘        │
      #            │                 │
      #   ┌────────▼────────┐        │
      #   │ kpi_visibility  │        │  ← PHASE 5
      #   └────────┬────────┘        │
      #            │                 │
      #   ┌────────▼────────┐        │
      #   │ kpi_mkt_share   │        │
      #   └────────┬────────┘        │
      #            │                 │
      #   ┌────────▼────────┐        │
      #   │   validation    │        │  ← PHASE 6
      #   └─────────────────┘        │
      #
      # ═══════════════════════════════════════════════════════════════════════
      
      tasks:
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 1: BRONZE INGESTION
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "bronze_ingestion"
          description: "Ingest raw data from sources into Bronze Delta tables"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/bronze/01_bronze_ingestion"
            source: "WORKSPACE"
          timeout_seconds: 1800
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 2: SILVER STANDARDIZATION
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "silver_standardization"
          description: "Transform Bronze to Silver with standardization"
          depends_on:
            - task_key: "bronze_ingestion"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/silver/02_silver_standardization"
            source: "WORKSPACE"
          timeout_seconds: 2400
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 3: GOLD DIMENSIONS (Parallel)
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_dim_date"
          description: "Calendar dimension (static, 10-year range)"
          depends_on:
            - task_key: "silver_standardization"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_date"
            source: "WORKSPACE"
          timeout_seconds: 600
        
        - task_key: "gold_dim_product"
          description: "Product dimension with SCD Type 2"
          depends_on:
            - task_key: "silver_standardization"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_product"
            source: "WORKSPACE"
          timeout_seconds: 900
        
        - task_key: "gold_dim_pdv"
          description: "Point of Sale dimension with SCD Type 2"
          depends_on:
            - task_key: "silver_standardization"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_pdv"
            source: "WORKSPACE"
          timeout_seconds: 900
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 4: GOLD FACTS (After dimensions)
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_fact_sell_in"
          description: "Sell-in fact table with dimension keys"
          depends_on:
            - task_key: "gold_dim_date"
            - task_key: "gold_dim_product"
            - task_key: "gold_dim_pdv"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/facts/gold_fact_sell_in"
            source: "WORKSPACE"
          timeout_seconds: 1800
        
        - task_key: "gold_fact_price_audit"
          description: "Price audit fact table"
          depends_on:
            - task_key: "gold_dim_date"
            - task_key: "gold_dim_product"
            - task_key: "gold_dim_pdv"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/facts/gold_fact_price_audit"
            source: "WORKSPACE"
          timeout_seconds: 1800
        
        - task_key: "gold_fact_stock"
          description: "Stock estimation fact table"
          depends_on:
            - task_key: "gold_fact_sell_in"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/facts/gold_fact_stock"
            source: "WORKSPACE"
          timeout_seconds: 1800
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 5: GOLD KPIs (After facts)
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_kpi_market_visibility"
          description: "Daily market visibility KPIs"
          depends_on:
            - task_key: "gold_fact_sell_in"
            - task_key: "gold_fact_price_audit"
            - task_key: "gold_fact_stock"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/kpis/gold_kpi_market_visibility"
            source: "WORKSPACE"
          timeout_seconds: 2400
        
        - task_key: "gold_kpi_market_share"
          description: "Market share analysis KPIs"
          depends_on:
            - task_key: "gold_kpi_market_visibility"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/kpis/gold_kpi_market_share"
            source: "WORKSPACE"
          timeout_seconds: 1800
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 6: VALIDATION
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_validation"
          description: "Data quality validation using Delta metadata"
          depends_on:
            - task_key: "gold_kpi_market_share"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/validation/gold_validation"
            source: "WORKSPACE"
          timeout_seconds: 600
