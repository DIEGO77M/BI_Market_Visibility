# =============================================================================
# FULL PIPELINE - END-TO-END ORCHESTRATION
# =============================================================================
# 
# Purpose: Complete Medallion Architecture pipeline (Bronze → Silver → Gold)
# Author: Diego Mayorga
# Date: 2026-01-06
# 
# This workflow orchestrates all layers with proper dependencies:
# - Phase 1: Bronze Ingestion
# - Phase 2: Silver Standardization
# - Phase 3: Gold Dimensions (parallel)
# - Phase 4: Gold Facts (parallel, after dimensions)
# - Phase 5: Gold KPIs (after facts)
# - Phase 6: Validation
#
# =============================================================================

resources:
  jobs:
    full_pipeline:
      name: "Full Pipeline - Bronze to Gold"
      description: |
        Complete end-to-end Medallion Architecture pipeline
        Executes all layers in sequence with proper dependencies
      
      tags:
        project: "BI_Market_Visibility"
        layer: "orchestration"
        environment: "${bundle.target}"
        owner: "diego.mayorgacapera@gmail.com"
      
      # ─────────────────────────────────────────────────────────────────────
      # CLUSTER CONFIGURATION
      # ─────────────────────────────────────────────────────────────────────
      job_clusters:
        - job_cluster_key: "pipeline_cluster"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 2
            autoscale:
              min_workers: 1
              max_workers: 6
            spark_conf:
              "spark.sql.adaptive.enabled": "true"
              "spark.sql.adaptive.coalescePartitions.enabled": "true"
              "spark.sql.adaptive.skewJoin.enabled": "true"
              "spark.databricks.delta.optimizeWrite.enabled": "true"
              "spark.databricks.delta.autoCompact.enabled": "true"
              "spark.sql.autoBroadcastJoinThreshold": "104857600"
            spark_env_vars:
              PYSPARK_PYTHON: "/databricks/python3/bin/python3"
      
      # ─────────────────────────────────────────────────────────────────────
      # NOTIFICATIONS
      # ─────────────────────────────────────────────────────────────────────
      email_notifications:
        on_start:
          - "diego.mayorgacapera@gmail.com"
        on_failure:
          - "diego.mayorgacapera@gmail.com"
        on_success:
          - "diego.mayorgacapera@gmail.com"
        no_alert_for_skipped_runs: true
      
      # ─────────────────────────────────────────────────────────────────────
      # TIMEOUT POLICY
      # ─────────────────────────────────────────────────────────────────────
      timeout_seconds: 14400  # 4 hours max for full pipeline
      
      # ─────────────────────────────────────────────────────────────────────
      # SCHEDULE: Weekly on Sunday at 2 AM (full refresh)
      # ─────────────────────────────────────────────────────────────────────
      schedule:
        quartz_cron_expression: "0 0 2 ? * SUN"
        timezone_id: "America/Bogota"
        pause_status: "PAUSED"
      
      # ═══════════════════════════════════════════════════════════════════════
      # TASK DEFINITIONS - DIRECTED ACYCLIC GRAPH (DAG)
      # ═══════════════════════════════════════════════════════════════════════
      #
      # Execution Flow:
      #
      #                    ┌─────────────────┐
      #                    │ bronze_ingestion│  ← PHASE 1
      #                    └────────┬────────┘
      #                             │
      #                    ┌────────▼────────┐
      #                    │silver_standard  │  ← PHASE 2
      #                    └────────┬────────┘
      #                             │
      #          ┌──────────────────┼──────────────────┐
      #          │                  │                  │
      #   ┌──────▼──────┐   ┌──────▼──────┐   ┌──────▼──────┐
      #   │  dim_date   │   │ dim_product │   │   dim_pdv   │  ← PHASE 3
      #   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
      #          │                 │                 │
      #          └─────────────────┼─────────────────┘
      #                            │
      #          ┌─────────────────┼─────────────────┐
      #          │                 │                 │
      #   ┌──────▼──────┐   ┌──────▼──────┐   ┌──────▼──────┐
      #   │fact_sell_in │   │fact_price_au│   │ fact_stock  │  ← PHASE 4
      #   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
      #          │                 │                 │
      #          └─────────────────┼─────────────────┘
      #                            │
      #          ┌─────────────────┼─────────────────┐
      #          │                                   │
      #   ┌──────▼──────────┐              ┌────────▼───────┐
      #   │kpi_mkt_visibility│              │kpi_market_share│ ← PHASE 5
      #   └──────┬──────────┘              └────────┬───────┘
      #          │                                  │
      #          └──────────────┬───────────────────┘
      #                         │
      #                ┌────────▼────────┐
      #                │   validation    │  ← PHASE 6
      #                └─────────────────┘
      #
      # ═══════════════════════════════════════════════════════════════════════
      
      tasks:
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 1: BRONZE INGESTION
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "bronze_ingestion"
          description: "Ingest raw data from sources into Bronze Delta tables"
          job_cluster_key: "pipeline_cluster"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/bronze/01_bronze_ingestion"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 1800
          max_retries: 2
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 2: SILVER STANDARDIZATION
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "silver_standardization"
          description: "Transform Bronze to Silver with standardization"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: "bronze_ingestion"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/silver/02_silver_standardization"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 2400
          max_retries: 2
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 3: GOLD DIMENSIONS (Parallel)
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_dim_date"
          description: "Calendar dimension (static, 10-year range)"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: "silver_standardization"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_date"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 600
          max_retries: 1
        
        - task_key: "gold_dim_product"
          description: "Product dimension with SCD Type 2"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: "silver_standardization"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_product"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 900
          max_retries: 1
        
        - task_key: "gold_dim_pdv"
          description: "Point of Sale dimension with SCD Type 2"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: "silver_standardization"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_pdv"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 900
          max_retries: 1
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 4: GOLD FACTS (Parallel, after dimensions)
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_fact_sell_in"
          description: "Sell-in fact table with dimension keys"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: "gold_dim_date"
            - task_key: "gold_dim_product"
            - task_key: "gold_dim_pdv"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/facts/gold_fact_sell_in"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 1800
          max_retries: 2
        
        - task_key: "gold_fact_price_audit"
          description: "Price audit fact table"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: "gold_dim_date"
            - task_key: "gold_dim_product"
            - task_key: "gold_dim_pdv"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/facts/gold_fact_price_audit"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 1800
          max_retries: 2
        
        - task_key: "gold_fact_stock"
          description: "Stock estimation fact table"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: "gold_fact_sell_in"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/facts/gold_fact_stock"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 1800
          max_retries: 2
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 5: GOLD KPIs (After facts)
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_kpi_market_visibility"
          description: "Daily market visibility KPIs"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: "gold_fact_sell_in"
            - task_key: "gold_fact_price_audit"
            - task_key: "gold_fact_stock"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/kpis/gold_kpi_market_visibility"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 2400
          max_retries: 2
        
        - task_key: "gold_kpi_market_share"
          description: "Market share analysis KPIs"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: "gold_kpi_market_visibility"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/kpis/gold_kpi_market_share"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 1800
          max_retries: 2
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 6: VALIDATION
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_validation"
          description: "Data quality validation using Delta metadata"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: "gold_kpi_market_share"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/validation/gold_validation"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 600
          max_retries: 1
