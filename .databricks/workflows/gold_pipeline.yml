# =============================================================================
# GOLD LAYER PIPELINE - SIMPLIFIED ORCHESTRATOR PATTERN
# =============================================================================
# 
# Purpose: Star Schema ETL for analytical consumption
# Author: Diego Mayorga
# Date: 2026-01-06
# Compute: Serverless (workspace requirement)
# 
# Strategy: Single task calls the orchestrator notebook which handles
#           all phases internally (dimensions → facts → kpis → validation)
#
# Trade-off Decision:
#   - Alternative A: YAML with 9 separate tasks (redundant with orchestrator)
#   - Alternative B: Single task calling orchestrator (CHOSEN)
#   - Gain: Centralized maintenance, widgets support, custom error handling
#   - Sacrifice: Native Databricks parallel execution (mitigated by orchestrator)
#
# =============================================================================

resources:
  jobs:
    gold_layer_pipeline:
      name: "Gold Layer - Dimensional Model"
      description: |
        Gold Layer pipeline via orchestrator notebook:
        - Phase 1: Dimensions (Date, Product, PDV) with SCD Type 2
        - Phase 2: Facts (Sell-In, Price Audit, Stock)
        - Phase 3: KPIs (Market Visibility, Market Share)
        - Phase 4: Validation (Zero-compute Delta metadata)
        
        The orchestrator handles sequencing, error handling, and metrics.
        Supports widgets: run_pipeline, stop_on_error, run_validation
      
      tags:
        project: "BI_Market_Visibility"
        layer: "gold"
        pattern: "orchestrator"
        owner: "diego.mayorgacapera@gmail.com"
      
      # ─────────────────────────────────────────────────────────────────────
      # NOTIFICATIONS
      # ─────────────────────────────────────────────────────────────────────
      email_notifications:
        on_failure:
          - "diego.mayorgacapera@gmail.com"
        on_success:
          - "diego.mayorgacapera@gmail.com"
        no_alert_for_skipped_runs: true
      
      # ─────────────────────────────────────────────────────────────────────
      # TIMEOUT POLICY
      # ─────────────────────────────────────────────────────────────────────
      timeout_seconds: 7200
      
      # ─────────────────────────────────────────────────────────────────────
      # SCHEDULE: Daily at 6 AM (after Silver completes)
      # ─────────────────────────────────────────────────────────────────────
      schedule:
        quartz_cron_expression: "0 0 6 * * ?"
        timezone_id: "America/Bogota"
        pause_status: "PAUSED"
      
      # ═══════════════════════════════════════════════════════════════════════
      # SINGLE TASK - Orchestrator handles all phases internally
      # ═══════════════════════════════════════════════════════════════════════
      #
      # Internal Execution Flow (managed by orchestrator):
      #
      #   ┌──────────┐  ┌─────────────┐  ┌──────────┐
      #   │ dim_date │  │ dim_product │  │ dim_pdv  │   ← Phase 1
      #   └────┬─────┘  └──────┬──────┘  └────┬─────┘
      #        └───────────────┼──────────────┘
      #                        ▼
      #   ┌─────────────┐  ┌──────────────┐  ┌────────────┐
      #   │fact_sell_in │  │fact_price_aud│  │ fact_stock │  ← Phase 2
      #   └──────┬──────┘  └──────┬───────┘  └─────┬──────┘
      #          └────────────────┼────────────────┘
      #                           ▼
      #   ┌──────────────────┐  ┌──────────────────┐
      #   │kpi_mkt_visibility│  │ kpi_market_share │  ← Phase 3
      #   └────────┬─────────┘  └────────┬─────────┘
      #            └─────────────────────┘
      #                        ▼
      #              ┌──────────────────┐
      #              │   validation     │  ← Phase 4
      #              └──────────────────┘
      #
      # ═══════════════════════════════════════════════════════════════════════
      
      tasks:
        - task_key: "gold_orchestrator"
          description: "Execute complete Gold Layer pipeline via orchestrator"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/.bundle/BI_Market_Visibility/dev/files/notebooks/gold/03_gold_orchestrator"
            source: "WORKSPACE"
            base_parameters:
              run_pipeline: "yes"
              stop_on_error: "yes"
              run_validation: "yes"
              timeout_seconds: "6000"
          timeout_seconds: 7200
