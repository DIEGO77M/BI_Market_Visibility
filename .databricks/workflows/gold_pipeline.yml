# =============================================================================
# GOLD LAYER PIPELINE - DATABRICKS SERVERLESS WORKFLOW
# =============================================================================
# 
# Purpose: Star Schema ETL for analytical consumption
# Author: Diego Mayorga
# Date: 2026-01-06
# Compute: Serverless (workspace requirement)
# 
# Execution Flow:
#   Dimensions (parallel) → Facts (parallel) → KPIs → Validation
#
# =============================================================================

resources:
  jobs:
    gold_layer_pipeline:
      name: "Gold Layer - Daily Pipeline"
      description: |
        Star Schema ETL pipeline (Serverless):
        - SCD Type 2 dimensions (Product, PDV, Date)
        - Incremental fact tables (Sell-In, Price Audit, Stock)
        - Pre-aggregated KPIs (Market Visibility, Market Share)
        - Zero-compute validation
      
      tags:
        project: "BI_Market_Visibility"
        layer: "gold"
        owner: "diego.mayorgacapera@gmail.com"
      
      # ─────────────────────────────────────────────────────────────────────
      # NOTIFICATIONS
      # ─────────────────────────────────────────────────────────────────────
      email_notifications:
        on_failure:
          - "diego.mayorgacapera@gmail.com"
        on_success:
          - "diego.mayorgacapera@gmail.com"
        no_alert_for_skipped_runs: true
      
      # ─────────────────────────────────────────────────────────────────────
      # TIMEOUT POLICY
      # ─────────────────────────────────────────────────────────────────────
      timeout_seconds: 7200
      
      # ─────────────────────────────────────────────────────────────────────
      # SCHEDULE: Daily at 6 AM (after Silver completes)
      # ─────────────────────────────────────────────────────────────────────
      schedule:
        quartz_cron_expression: "0 0 6 * * ?"
        timezone_id: "America/Bogota"
        pause_status: "PAUSED"
      
      # ═══════════════════════════════════════════════════════════════════════
      # TASK DEFINITIONS (Serverless Compute)
      # ═══════════════════════════════════════════════════════════════════════
      #
      # DAG Structure:
      #
      #   ┌──────────┐  ┌─────────────┐  ┌──────────┐
      #   │ dim_date │  │ dim_product │  │ dim_pdv  │   ← PHASE 1 (Parallel)
      #   └────┬─────┘  └──────┬──────┘  └────┬─────┘
      #        └───────────────┼──────────────┘
      #                        ▼
      #   ┌─────────────┐  ┌──────────────┐  ┌────────────┐
      #   │fact_sell_in │  │fact_price_aud│  │ fact_stock │  ← PHASE 2
      #   └──────┬──────┘  └──────┬───────┘  └─────┬──────┘
      #          └────────────────┼────────────────┘
      #                           ▼
      #   ┌──────────────────┐  ┌──────────────────┐
      #   │kpi_mkt_visibility│  │ kpi_market_share │  ← PHASE 3
      #   └────────┬─────────┘  └────────┬─────────┘
      #            └─────────────────────┘
      #                        ▼
      #              ┌──────────────────┐
      #              │   validation     │  ← PHASE 4
      #              └──────────────────┘
      #
      # ═══════════════════════════════════════════════════════════════════════
      
      tasks:
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 1: DIMENSIONS (Parallel execution)
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_dim_date"
          description: "Calendar dimension (static, 10-year range)"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_date"
            source: "WORKSPACE"
          timeout_seconds: 600
          
        - task_key: "gold_dim_product"
          description: "Product dimension with SCD Type 2"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_product"
            source: "WORKSPACE"
          timeout_seconds: 900
          
        - task_key: "gold_dim_pdv"
          description: "Point of Sale dimension with SCD Type 2"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_pdv"
            source: "WORKSPACE"
          timeout_seconds: 900
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 2: FACTS (After dimensions)
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_fact_sell_in"
          description: "Sell-in fact table with dimension keys"
          depends_on:
            - task_key: "gold_dim_date"
            - task_key: "gold_dim_product"
            - task_key: "gold_dim_pdv"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/facts/gold_fact_sell_in"
            source: "WORKSPACE"
          timeout_seconds: 1800
          
        - task_key: "gold_fact_price_audit"
          description: "Price audit fact table"
          depends_on:
            - task_key: "gold_dim_date"
            - task_key: "gold_dim_product"
            - task_key: "gold_dim_pdv"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/facts/gold_fact_price_audit"
            source: "WORKSPACE"
          timeout_seconds: 1800
          
        - task_key: "gold_fact_stock"
          description: "Stock estimation fact table"
          depends_on:
            - task_key: "gold_fact_sell_in"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/facts/gold_fact_stock"
            source: "WORKSPACE"
          timeout_seconds: 1800
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 3: KPIs (After facts)
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_kpi_market_visibility"
          description: "Daily market visibility KPIs"
          depends_on:
            - task_key: "gold_fact_sell_in"
            - task_key: "gold_fact_price_audit"
            - task_key: "gold_fact_stock"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/kpis/gold_kpi_market_visibility"
            source: "WORKSPACE"
          timeout_seconds: 2400
          
        - task_key: "gold_kpi_market_share"
          description: "Market share analysis KPIs"
          depends_on:
            - task_key: "gold_kpi_market_visibility"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/kpis/gold_kpi_market_share"
            source: "WORKSPACE"
          timeout_seconds: 1800
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 4: VALIDATION
        # ─────────────────────────────────────────────────────────────────────
        - task_key: "gold_validation"
          description: "Data quality validation using Delta metadata"
          depends_on:
            - task_key: "gold_kpi_market_share"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/gold/validation/gold_validation"
            source: "WORKSPACE"
          timeout_seconds: 600
