# =============================================================================
# GOLD LAYER PIPELINE - DATABRICKS WORKFLOW
# =============================================================================
# 
# Purpose: Production-grade orchestration for Gold Layer ETL
# Author: Diego Mayorga
# Date: 2026-01-06
# 
# This workflow provides:
# - Parallel execution where dependencies allow
# - Individual task retry on failure
# - Native Databricks monitoring and alerting
# - Cost-efficient job cluster usage
#
# Deployment:
#   databricks bundle deploy --target prod
#
# Manual Run:
#   databricks jobs run-now --job-id <job_id>
#
# =============================================================================

resources:
  jobs:
    gold_layer_pipeline:
      name: "Gold Layer - Daily Pipeline"
      description: |
        Star schema ETL pipeline with:
        - SCD Type 2 dimensions (Product, PDV)
        - Incremental fact tables (Sell-In, Price Audit, Stock)
        - Pre-aggregated KPIs (Market Visibility, Market Share)
        - Zero-compute validation
      
      tags:
        project: "BI_Market_Visibility"
        layer: "gold"
        environment: "${bundle.target}"
        owner: "diego.mayorgacapera@gmail.com"
      
      # ─────────────────────────────────────────────────────────────────────
      # CLUSTER CONFIGURATION (Cost-efficient for scheduled jobs)
      # ─────────────────────────────────────────────────────────────────────
      job_clusters:
        - job_cluster_key: "gold_cluster"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 2
            autoscale:
              min_workers: 1
              max_workers: 4
            spark_conf:
              # Adaptive Query Execution (AQE) for scalability
              "spark.sql.adaptive.enabled": "true"
              "spark.sql.adaptive.coalescePartitions.enabled": "true"
              "spark.sql.adaptive.skewJoin.enabled": "true"
              "spark.sql.shuffle.partitions": "auto"
              # Delta optimizations
              "spark.databricks.delta.optimizeWrite.enabled": "true"
              "spark.databricks.delta.autoCompact.enabled": "true"
              # Broadcast threshold (100MB for dimension joins)
              "spark.sql.autoBroadcastJoinThreshold": "104857600"
            spark_env_vars:
              PYSPARK_PYTHON: "/databricks/python3/bin/python3"
            custom_tags:
              ResourceClass: "SingleNode"
      
      # ─────────────────────────────────────────────────────────────────────
      # NOTIFICATIONS
      # ─────────────────────────────────────────────────────────────────────
      email_notifications:
        on_failure:
          - "diego.mayorgacapera@gmail.com"
        on_success:
          - "diego.mayorgacapera@gmail.com"
        no_alert_for_skipped_runs: true
      
      # ─────────────────────────────────────────────────────────────────────
      # TIMEOUT POLICY
      # ─────────────────────────────────────────────────────────────────────
      timeout_seconds: 7200  # 2 hours max for full pipeline
      
      # ─────────────────────────────────────────────────────────────────────
      # SCHEDULE: Daily at 6 AM UTC
      # ─────────────────────────────────────────────────────────────────────
      schedule:
        quartz_cron_expression: "0 0 6 * * ?"
        timezone_id: "UTC"
        pause_status: "PAUSED"  # Set to UNPAUSED for production
      
      # ═══════════════════════════════════════════════════════════════════════
      # TASK DEFINITIONS (Directed Acyclic Graph)
      # ═══════════════════════════════════════════════════════════════════════
      #
      # Execution Flow:
      #
      #   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
      #   │ dim_date    │   │ dim_product │   │  dim_pdv    │  ← PHASE 1 (Parallel)
      #   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
      #          │                 │                 │
      #          └─────────────────┼─────────────────┘
      #                            ▼
      #   ┌─────────────────────────────────────────────────┐
      #   │        fact_sell_in    fact_price_audit         │  ← PHASE 2 (Parallel)
      #   └──────────────┬────────────────┬─────────────────┘
      #                  │                │
      #                  ▼                │
      #            ┌───────────┐          │
      #            │fact_stock │──────────┘                    ← PHASE 2.5
      #            └─────┬─────┘
      #                  │
      #                  ▼
      #   ┌─────────────────────────────────────────────────┐
      #   │   kpi_market_visibility → kpi_market_share      │  ← PHASE 3 (Sequential)
      #   └──────────────────────┬──────────────────────────┘
      #                          │
      #                          ▼
      #                  ┌──────────────┐
      #                  │  validation  │                      ← PHASE 4
      #                  └──────────────┘
      #
      # ═══════════════════════════════════════════════════════════════════════
      
      tasks:
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 1: DIMENSIONS (No dependencies - can run in parallel)
        # ─────────────────────────────────────────────────────────────────────
        
        - task_key: "gold_dim_date"
          description: "Calendar dimension (static, ~3.6K rows, 10-year range)"
          job_cluster_key: "gold_cluster"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_date"
            base_parameters:
              env: "${bundle.target}"
            source: "WORKSPACE"
          timeout_seconds: 600  # 10 min max
          max_retries: 1
          
        - task_key: "gold_dim_product"
          description: "Product dimension with SCD Type 2 (~250 rows)"
          job_cluster_key: "gold_cluster"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_product"
            base_parameters:
              env: "${bundle.target}"
            source: "WORKSPACE"
          timeout_seconds: 900  # 15 min max
          max_retries: 1
          
        - task_key: "gold_dim_pdv"
          description: "Point of Sale dimension with SCD Type 2 (~75 rows)"
          job_cluster_key: "gold_cluster"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/dimensions/gold_dim_pdv"
            base_parameters:
              env: "${bundle.target}"
            source: "WORKSPACE"
          timeout_seconds: 900  # 15 min max
          max_retries: 1
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 2: FACTS (Depend on dimensions, sell_in and price_audit parallel)
        # ─────────────────────────────────────────────────────────────────────
        
        - task_key: "gold_fact_sell_in"
          description: "Sell-in fact table with dimension keys (DPO by year)"
          job_cluster_key: "gold_cluster"
          depends_on:
            - task_key: "gold_dim_date"
            - task_key: "gold_dim_product"
            - task_key: "gold_dim_pdv"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/facts/gold_fact_sell_in"
            base_parameters:
              env: "${bundle.target}"
              incremental: "true"
            source: "WORKSPACE"
          timeout_seconds: 1800  # 30 min max
          max_retries: 2
          
        - task_key: "gold_fact_price_audit"
          description: "Price audit fact table (DPO by year_month)"
          job_cluster_key: "gold_cluster"
          depends_on:
            - task_key: "gold_dim_date"
            - task_key: "gold_dim_product"
            - task_key: "gold_dim_pdv"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/facts/gold_fact_price_audit"
            base_parameters:
              env: "${bundle.target}"
              incremental: "true"
            source: "WORKSPACE"
          timeout_seconds: 1800  # 30 min max
          max_retries: 2
          
        - task_key: "gold_fact_stock"
          description: "Stock estimation derived from sell-in"
          job_cluster_key: "gold_cluster"
          depends_on:
            - task_key: "gold_fact_sell_in"  # Derived from sell-in data
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/facts/gold_fact_stock"
            base_parameters:
              env: "${bundle.target}"
            source: "WORKSPACE"
          timeout_seconds: 1800  # 30 min max
          max_retries: 2
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 3: KPIs (Depend on all facts)
        # ─────────────────────────────────────────────────────────────────────
        
        - task_key: "gold_kpi_market_visibility"
          description: "Daily market visibility KPIs for operational dashboards"
          job_cluster_key: "gold_cluster"
          depends_on:
            - task_key: "gold_fact_sell_in"
            - task_key: "gold_fact_price_audit"
            - task_key: "gold_fact_stock"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/kpis/gold_kpi_market_visibility"
            base_parameters:
              env: "${bundle.target}"
            source: "WORKSPACE"
          timeout_seconds: 2400  # 40 min max
          max_retries: 2
          
        - task_key: "gold_kpi_market_share"
          description: "Market share analysis KPIs for executive dashboards"
          job_cluster_key: "gold_cluster"
          depends_on:
            - task_key: "gold_kpi_market_visibility"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/kpis/gold_kpi_market_share"
            base_parameters:
              env: "${bundle.target}"
            source: "WORKSPACE"
          timeout_seconds: 1800  # 30 min max
          max_retries: 2
        
        # ─────────────────────────────────────────────────────────────────────
        # PHASE 4: VALIDATION (Read-only, post-execution)
        # ─────────────────────────────────────────────────────────────────────
        
        - task_key: "gold_validation"
          description: "Zero-compute validation using Delta metadata"
          job_cluster_key: "gold_cluster"
          depends_on:
            - task_key: "gold_kpi_market_share"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/gold/validation/gold_validation"
            base_parameters:
              env: "${bundle.target}"
              alert_on_failure: "true"
            source: "WORKSPACE"
          timeout_seconds: 600  # 10 min max
          max_retries: 1