# =============================================================================
# SILVER LAYER PIPELINE - DATABRICKS WORKFLOW
# =============================================================================
# 
# Purpose: Data standardization and quality transformations
# Author: Diego Mayorga
# Date: 2026-01-06
# 
# This workflow transforms Bronze → Silver with:
# - Schema standardization (snake_case, explicit types)
# - Data quality validations
# - Deduplication with deterministic ordering
# - Domain validations (prices, dates, quantities)
#
# =============================================================================

resources:
  jobs:
    silver_layer_pipeline:
      name: "Silver Layer - Daily Standardization"
      description: |
        Data standardization pipeline:
        - Master PDV standardization
        - Master Products standardization
        - Price Audit cleaning and validation
        - Sell-In transformation with quality flags
      
      tags:
        project: "BI_Market_Visibility"
        layer: "silver"
        environment: "${bundle.target}"
        owner: "diego.mayorgacapera@gmail.com"
      
      # ─────────────────────────────────────────────────────────────────────
      # CLUSTER CONFIGURATION (Serverless)
      # ─────────────────────────────────────────────────────────────────────
      job_clusters:
        - job_cluster_key: "silver_cluster"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 2
            autoscale:
              min_workers: 1
              max_workers: 4
            spark_conf:
              "spark.sql.adaptive.enabled": "true"
              "spark.sql.adaptive.coalescePartitions.enabled": "true"
              "spark.databricks.delta.optimizeWrite.enabled": "true"
              "spark.databricks.delta.autoCompact.enabled": "true"
            spark_env_vars:
              PYSPARK_PYTHON: "/databricks/python3/bin/python3"
            custom_tags:
              ResourceClass: "SingleNode"
      
      # ─────────────────────────────────────────────────────────────────────
      # NOTIFICATIONS
      # ─────────────────────────────────────────────────────────────────────
      email_notifications:
        on_failure:
          - "diego.mayorgacapera@gmail.com"
        no_alert_for_skipped_runs: true
      
      # ─────────────────────────────────────────────────────────────────────
      # TIMEOUT POLICY
      # ─────────────────────────────────────────────────────────────────────
      timeout_seconds: 3600  # 1 hour max
      
      # ─────────────────────────────────────────────────────────────────────
      # SCHEDULE: Daily at 4 AM UTC (after Bronze completes at 3 AM)
      # ─────────────────────────────────────────────────────────────────────
      schedule:
        quartz_cron_expression: "0 0 4 * * ?"
        timezone_id: "America/Bogota"
        pause_status: "PAUSED"
      
      # ═══════════════════════════════════════════════════════════════════════
      # TASK DEFINITIONS
      # ═══════════════════════════════════════════════════════════════════════
      tasks:
        - task_key: "silver_standardization"
          description: "Transform all Bronze tables to Silver with standardization"
          job_cluster_key: "silver_cluster"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/notebooks/silver/02_silver_standardization"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 2400  # 40 min max
          max_retries: 2
        
        - task_key: "silver_drift_monitoring"
          description: "Schema drift detection for Silver layer"
          job_cluster_key: "silver_cluster"
          depends_on:
            - task_key: "silver_standardization"
          notebook_task:
            notebook_path: "/Repos/BI_Market_Visibility/monitoring/silver_drift_monitoring"
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
            source: "WORKSPACE"
          timeout_seconds: 600  # 10 min max
          max_retries: 1
