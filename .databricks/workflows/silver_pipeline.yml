# =============================================================================
# SILVER LAYER PIPELINE - DATABRICKS SERVERLESS WORKFLOW
# =============================================================================
# 
# Purpose: Data standardization and quality transformations
# Author: Diego Mayorga
# Date: 2026-01-06
# Compute: Serverless (workspace requirement)
# 
# =============================================================================

resources:
  jobs:
    silver_layer_pipeline:
      name: "Silver Layer - Daily Standardization"
      description: |
        Data standardization pipeline (Serverless):
        - Schema standardization (snake_case, explicit types)
        - Data quality validations
        - Deduplication with deterministic ordering
        - Domain validations (prices, dates, quantities)
      
      tags:
        project: "BI_Market_Visibility"
        layer: "silver"
        owner: "diego.mayorgacapera@gmail.com"
      
      # ─────────────────────────────────────────────────────────────────────
      # NOTIFICATIONS
      # ─────────────────────────────────────────────────────────────────────
      email_notifications:
        on_failure:
          - "diego.mayorgacapera@gmail.com"
        no_alert_for_skipped_runs: true
      
      # ─────────────────────────────────────────────────────────────────────
      # TIMEOUT POLICY
      # ─────────────────────────────────────────────────────────────────────
      timeout_seconds: 3600
      
      # ─────────────────────────────────────────────────────────────────────
      # SCHEDULE: Daily at 4 AM (after Bronze completes)
      # ─────────────────────────────────────────────────────────────────────
      schedule:
        quartz_cron_expression: "0 0 4 * * ?"
        timezone_id: "America/Bogota"
        pause_status: "PAUSED"
      
      # ═══════════════════════════════════════════════════════════════════════
      # TASK DEFINITIONS (Serverless Compute)
      # ═══════════════════════════════════════════════════════════════════════
      tasks:
        - task_key: "silver_standardization"
          description: "Transform all Bronze tables to Silver with standardization"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/notebooks/silver/02_silver_standardization"
            source: "WORKSPACE"
          timeout_seconds: 2400
        
        - task_key: "silver_drift_monitoring"
          description: "Schema drift detection for Silver layer"
          depends_on:
            - task_key: "silver_standardization"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/BI_Market_Visibility/monitoring/silver_drift_monitoring"
            source: "WORKSPACE"
          timeout_seconds: 600
