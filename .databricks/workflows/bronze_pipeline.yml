# =============================================================================
# BRONZE LAYER PIPELINE - DATABRICKS SERVERLESS WORKFLOW
# =============================================================================
# 
# Purpose: Raw data ingestion from sources into Bronze Delta tables
# Author: Diego Mayorga
# Date: 2026-01-06
# Compute: Serverless (workspace requirement)
# 
# =============================================================================

resources:
  jobs:
    bronze_layer_pipeline:
      name: "Bronze Layer - Daily Ingestion"
      description: |
        Raw data ingestion pipeline (Serverless):
        - Master PDV from CSV
        - Master Products from CSV
        - Price Audit from CSV
        - Sell-In from CSV
      
      tags:
        project: "BI_Market_Visibility"
        layer: "bronze"
        owner: "diego.mayorgacapera@gmail.com"
      
      # ─────────────────────────────────────────────────────────────────────
      # NOTIFICATIONS
      # ─────────────────────────────────────────────────────────────────────
      email_notifications:
        on_failure:
          - "diego.mayorgacapera@gmail.com"
        no_alert_for_skipped_runs: true
      
      # ─────────────────────────────────────────────────────────────────────
      # TIMEOUT POLICY
      # ─────────────────────────────────────────────────────────────────────
      timeout_seconds: 3600
      
      # ─────────────────────────────────────────────────────────────────────
      # SCHEDULE: Daily at 3 AM (Bogota timezone)
      # ─────────────────────────────────────────────────────────────────────
      schedule:
        quartz_cron_expression: "0 0 3 * * ?"
        timezone_id: "America/Bogota"
        pause_status: "PAUSED"
      
      # ═══════════════════════════════════════════════════════════════════════
      # TASK DEFINITIONS (Serverless Compute)
      # ═══════════════════════════════════════════════════════════════════════
      tasks:
        - task_key: "bronze_ingestion"
          description: "Ingest raw data from CSV sources into Bronze Delta tables"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/.bundle/BI_Market_Visibility/dev/files/notebooks/bronze/01_bronze_ingestion"
            source: "WORKSPACE"
          timeout_seconds: 1800
        
        - task_key: "bronze_drift_monitoring"
          description: "Schema drift detection for Bronze layer"
          depends_on:
            - task_key: "bronze_ingestion"
          notebook_task:
            notebook_path: "/Workspace/Users/diego.mayorgacapera@gmail.com/.bundle/BI_Market_Visibility/dev/files/monitoring/drift_monitoring_bronze"
            source: "WORKSPACE"
          timeout_seconds: 600
