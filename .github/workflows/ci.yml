# =============================================================================
# CI/CD PIPELINE - BI Market Visibility
# =============================================================================
# Project: Market Visibility Analytics Platform
# Author: Diego Mayorga
# Last Updated: 2026-01-06
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'notebooks/**'
      - 'src/**'
      - 'monitoring/**'
      - 'requirements.txt'
      - '.databricks/**'
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.10'
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
  DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

jobs:
  # ===========================================================================
  # CODE QUALITY - Linting and Static Analysis
  # ===========================================================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort

    - name: Run flake8
      run: |
        flake8 notebooks/ --max-line-length=127 --ignore=E501,W503,E402 --count --statistics
      continue-on-error: true

    - name: Check code formatting with black
      run: |
        black --check notebooks/ || true

    - name: Check import sorting with isort
      run: |
        isort --check-only notebooks/ || true

  # ===========================================================================
  # SYNTAX VALIDATION - All Layers
  # ===========================================================================
  syntax-validation:
    name: Python Syntax Validation
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Validate Bronze Layer
      run: |
        echo "=== Validating Bronze Layer ==="
        python -m py_compile notebooks/bronze/01_bronze_ingestion.py
        echo "✓ 01_bronze_ingestion.py"

    - name: Validate Silver Layer
      run: |
        echo "=== Validating Silver Layer ==="
        python -m py_compile notebooks/silver/02_silver_standardization.py
        echo "✓ 02_silver_standardization.py"

    - name: Validate Gold Dimensions
      run: |
        echo "=== Validating Gold Dimensions ==="
        python -m py_compile notebooks/gold/dimensions/gold_dim_date.py
        python -m py_compile notebooks/gold/dimensions/gold_dim_product.py
        python -m py_compile notebooks/gold/dimensions/gold_dim_pdv.py
        echo "✓ All dimension notebooks validated"

    - name: Validate Gold Facts
      run: |
        echo "=== Validating Gold Facts ==="
        python -m py_compile notebooks/gold/facts/gold_fact_sell_in.py
        python -m py_compile notebooks/gold/facts/gold_fact_price_audit.py
        python -m py_compile notebooks/gold/facts/gold_fact_stock.py
        echo "✓ All fact notebooks validated"

    - name: Validate Gold KPIs
      run: |
        echo "=== Validating Gold KPIs ==="
        python -m py_compile notebooks/gold/kpis/gold_kpi_market_visibility.py
        python -m py_compile notebooks/gold/kpis/gold_kpi_market_share.py
        echo "✓ All KPI notebooks validated"

    - name: Validate Gold Validation & Orchestrator
      run: |
        echo "=== Validating Gold Validation & Orchestrator ==="
        python -m py_compile notebooks/gold/validation/gold_validation.py
        python -m py_compile notebooks/gold/03_gold_orchestrator.py
        echo "✓ Validation and orchestrator notebooks validated"

    - name: Validate Monitoring Scripts
      run: |
        echo "=== Validating Monitoring Scripts ==="
        python -m py_compile monitoring/drift_monitoring_bronze.py
        python -m py_compile monitoring/silver_drift_monitoring.py
        echo "✓ All monitoring scripts validated"

  # ===========================================================================
  # UNIT TESTS
  # ===========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [code-quality, syntax-validation]
    strategy:
      matrix:
        python-version: ['3.9', '3.10']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run unit tests
      run: |
        if [ -d "src/tests" ] && [ "$(ls -A src/tests/*.py 2>/dev/null)" ]; then
          pytest src/tests/ -v --cov=src --cov-report=xml --cov-report=term
        else
          echo "No tests found, skipping..."
        fi

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

  # ===========================================================================
  # SECURITY SCAN
  # ===========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit

    - name: Run safety check
      run: |
        pip install -r requirements.txt
        safety check --json || true

    - name: Run bandit security linter
      run: |
        bandit -r notebooks/ src/ -f json -o bandit-report.json || true

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json

  # ===========================================================================
  # DATABRICKS BUNDLE VALIDATION
  # ===========================================================================
  databricks-validate:
    name: Databricks Bundle Validation
    runs-on: ubuntu-latest
    needs: [syntax-validation]
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Databricks CLI
      uses: databricks/setup-cli@main

    - name: Validate Databricks Bundle
      run: |
        databricks bundle validate
      env:
        DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
        DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

  # ===========================================================================
  # DEPLOY TO DEVELOPMENT
  # ===========================================================================
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: development

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Databricks CLI
      uses: databricks/setup-cli@main

    - name: Deploy to Development
      run: |
        databricks bundle deploy --target dev
      env:
        DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
        DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

  # ===========================================================================
  # DEPLOY TO PRODUCTION
  # ===========================================================================
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Databricks CLI
      uses: databricks/setup-cli@main

    - name: Deploy to Production
      run: |
        databricks bundle deploy --target prod
      env:
        DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
        DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
